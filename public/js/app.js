var app=angular.module("kickerApp",["ngRoute","ui.select","ngSanitize","ui.bootstrap","ngFileUpload","ngResource","ngAnimate"]).config(["$httpProvider","$routeProvider",function(t,e){e.when("/signup",{controller:"SignupCtrl",templateUrl:"html/auth/signup.html"}).when("/signin",{controller:"SigninCtrl",templateUrl:"html/auth/signin.html"}).when("/",{controller:"GamesCtrl",templateUrl:"html/games/index.html"}).when("/game/create",{controller:"CreateGameCtrl",templateUrl:"html/games/create.html"}).when("/game/:id/update",{controller:"UpdateGameCtrl",templateUrl:"html/games/update.html"}).when("/game/:id/complainers",{controller:"ComplainersCtrl",templateUrl:"html/games/complainers.html"}).when("/admin/users",{templateUrl:"html/admin/users.html",controller:"UsersEditCtrl"}).when("/user/profile",{templateUrl:"html/user/profile.html",controller:"UserProfileCtrl"}).when("/chart",{templateUrl:"html/chart/index.html"}).when("/_=_",{controller:"GamesCtrl",templateUrl:"html/games/index.html"}),$(window).on("popstate",function(){$(".navbar-collapse").collapse("hide")}),$("body").on("click",".navbar-collapse li",function(){$(this).closest(".navbar-collapse").collapse("hide")})}]);Date.parseISO=function(t){var e=new Date(t);if(isNaN(e.getDate())){for(var n=t.split(" "),r=n[0].split("-"),a=n[1].split(":"),i=0;i<r.length;i++)r[i]=parseInt(r[i]);for(i=0;i<a.length;i++)a[i]=parseInt(a[i]);e=new Date(r[0],r[1]-1,r[2],a[0],a[1],a[2])}return e},function(t){t.directive("backImg",function(){return function(t,e,n){n.$observe("backImg",function(t){e.css({"background-image":"url("+t+")","background-size":"cover"})})}})}(angular.module("kickerApp")),function(t){t.directive("numberOnly",function(){return{require:"ngModel",link:function(t,e,n,r){r.$parsers.push(function(t){var e=parseInt(t),a=parseInt(n.min),i=parseInt(n.max),s=a;return s=e>i?i:e>=a?e:a,r.$setViewValue(s),r.$render(),s})}}})}(angular.module("kickerApp")),app.factory("User",["$http",function(t){function e(t){var e=this;this.editing=!1,this.win_rate=0,this.count_games=0,this.setData=function(t){angular.extend(this,t);var a=["count_looses","count_wins","count_draws"];for(index in a)a.hasOwnProperty(index)&&(e[a[index]]=parseInt(e[a[index]]),e[a[index]]=isNaN(e[a[index]])?0:e[a[index]]);e.count_games=n(),e.win_rate=r()};var n=function(){return e.count_games=e.count_looses+e.count_wins+e.count_draws,e.count_games},r=function(){return!e.count_games||isNaN(e.count_games)?e.win_rate=0:e.win_rate=Math.floor(e.count_wins/e.count_games*10*100)/10,e.win_rate};return this.avatarUrl=function(){return e.avatar_url?e.avatar_url:"/img/no-avatar.min.png"},this.getFormData=function(){var t={name:e.name,email:e.email};return e.password&&(t.password=e.password),t},t&&this.setData(t),this}return e}]),app.controller("ChartsCtrl",["$scope","$http","User",function(t,e,n){t.orderByField="index",t.reverseSort=!1,t.users=[],t.me=null,t.init=function(){t.loading=!0,e.get("/chart").success(function(e){angular.forEach(e,function(t,e){t.index=e+1;var r=new n(t);this.push(r)},t.users)})},e.get("/user/me").success(function(e){return e?void(t.me=new n(e)):!1}),t.init()}]),app.factory("GameUser",["$http","User",function(t,e){function n(t){var n=this;return this.setData=function(t){angular.extend(this,t),n.user=new e(n.user)},this.getDelta=function(){return n.rating_after-n.rating_before},this.userPointsClass=function(){return n.getDelta()>0?"win":"lose"},t&&this.setData(t),this}return n}]),app.factory("Game",["$http","$filter","$sce","GameUser","User",function(t,e,n,r,a){function i(t){var i=this;return this.complaintsHtml="",this.tooltipIsVisible=!1,this.loading=!1,this.setData=function(t){angular.extend(this,t);for(var s=0;s<i.games_users_a.length;s++)i.games_users_a[s]=new r(i.games_users_a[s]);for(s=0;s<i.games_users_b.length;s++)i.games_users_b[s]=new r(i.games_users_b[s]);for(s=0;s<i.complaints.length;s++)i.complaints[s].user=new a(i.complaints[s].user);i.played_at=function(t){return e("date")(t,"MM/dd/yyyy HH:mm")}(Date.parseISO(i.played_at)),i.complaintsHtml=function(t){var e=5,r="",a=t.length>e?e:t.length;if(t.length<=0)return null;for(var s=0;a>s;s++){var o=i.complaints[s].user;o&&(r+='<span class="complain-user"><img src="'+o.avatarUrl()+'" /></span>')}return r+='<div><a href="#/game/'+i.id+'/complainers" class="see-all-complainers">See all</a></div>',n.trustAsHtml(r)}(i.complaints)},this.gamePointClass=function(t){var e=i.team_a_points,n=i.team_b_points;return"b"===t&&(e=i.team_b_points,n=i.team_a_points),e=parseInt(e,10),e=isNaN(e)?0:e,n=parseInt(n,10),n=isNaN(n)?0:n,e>n?"win":n>e?"lose":"draw"},t&&this.setData(t),this}return i.prototype.MAX_POINTS=10,i.prototype.MIN_POINTS=0,i}]),app.factory("CreateGameService",["$http","$filter",function(t,e){function n(t){function n(t){return e("date")(t,"MM/dd/yyyy HH:mm")}var r=this;return this.id=null,this.users={a:[],b:[]},this.points={a:0,b:0},this.playedAt=n(new Date),this.teamIds=function(t){var e=this.users[t],n=[];return angular.forEach(e,function(t){this.push(t.id)},n),n},this.getSelectedIds=function(){return this.teamIds("a").concat(this.teamIds("b"))},this.exportUsers=function(t,e){var n=[];return angular.forEach(t["games_users_"+e],function(t){this.push(t.user)},n),n},this.setData=function(t){r.users={a:r.exportUsers(t,"a"),b:r.exportUsers(t,"b")},r.points={a:t.team_a_points,b:t.team_b_points},r.playedAt=n(Date.parseISO(t.played_at)),r.id=t.id},this.getFormData=function(){return{games_users_a:r.teamIds("a"),team_a_points:r.points.a,games_users_b:r.teamIds("b"),team_b_points:r.points.b,played_at:r.playedAt}},t&&this.setData(t),this}return n.prototype.MAX_POINTS=10,n.prototype.MIN_POINTS=0,n}]),app.factory("UserSearch",["$http",function(t){function e(){}return e.find=function(e,n){if(n.searchRequestPending||null===n.game)return!1;n.searchRequestPending=!0;var r=n.game.getSelectedIds(),a={};return e=e?e.trim():e,r.length>0&&(a["exceptIds[]"]=r),e&&(a.search=e),t.get("/user/search",{params:a}).then(function(t){0===t.data.length?n.usersSearch=[{name:"No results..."}]:n.usersSearch=t.data,n.searchRequestPending=!1})},e.remove=function(t,e){for(var n=0;n<e.usersSearch.length;n++)if(t.id===e.usersSearch[n].id){e.usersSearch.splice(n,1);break}},e.add=function(t,e){e.usersSearch.unshift(t)},e}]),function(t){t.factory("Player",["$resource",function(t){return t("user/me",{id:"@id"},{get:{method:"GET",isArray:!1},update:{method:"PUT",url:"user/:id"}})}])}(angular.module("kickerApp")),app.factory("GamesRepository",["$http","Game",function(t,e){function n(){var n=this;this.storage=[],this.loading=!0,this.lastpage=0,this.currentpage=0,this.filters={page:this.currentpage,usersGames:!1};var r={};return this.add=function(t){angular.forEach(t,function(t){var n=new e(t);this.push(n),r[n.id]=this.length-1},n.storage)},this.get=function(t){var e=r[t];return n.storage.hasOwnProperty(e)?n.storage[e]:null},this.update=function(t,r){var a=n.get(t);return angular.copy(new e(r),a),a},this.load=function(e){e&&(n.currentpage=0);var r=function(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n],"boolean"==typeof e[n]&&(e[n]*=1));return e}(this.filters);n.loading=!0,t({url:"/",method:"GET",params:r}).success(function(t){e&&n.storage.splice(0,n.storage.length),t.data.length>0&&(n.currentpage=t.current_page,n.lastpage=t.last_page,n.add(t.data)),n.loading=!1})},this}return n}]),app.controller("GamesCtrl",["$scope","$http","Game","GamesRepository",function(t,e,n,r){function a(){e({url:"/user/role",method:"GET"}).success(function(e){"guest"===e?t.user.isGuest=!0:"user"===e?t.user.isUser=!0:"admin"===e&&(t.user.isAdmin=!0)})}t.gamesRepository=new r,t.games=t.gamesRepository.storage,t.gamesRepository.load(),t.user={isGuest:!1,isUser:!1,isAdmin:!1},t.userRole=a(),t.complain=function(n){var r=t.gamesRepository.get(n);r.loading=!0,e.get("/game/"+n+"/complain").success(function(a){e.get("/game/"+n).success(function(e){r.loading=!1,t.gamesRepository.update(e.id,e)})})}}]),app.controller("CreateGameCtrl",["$scope","$http","$location","$filter","CreateGameService","UserSearch",function(t,e,n,r,a,i){t.loading=!1,t.game=new a,t.errors={},t.findUsers=function(e){i.find(e,t)},t.onSelectUser=function(e){i.remove(e,t)},t.onRemoveUser=function(e){i.add(e,t)},t.create=function(){t.errors={},t.loading=!0,e.post("/game",t.game.getFormData()).error(function(e){t.errors=e}).then(function(){t.loading=!1,n.path("/")},function(){t.loading=!1})};var s=$("#playedAt");s.datetimepicker({format:"MM/DD/YYYY HH:mm",maxDate:new Date}),s.on("dp.change",function(){t.game.playedAt=$(this).val()})}]),app.controller("UpdateGameCtrl",["$scope","$http","$location","$filter","$routeParams","CreateGameService","UserSearch",function(t,e,n,r,a,i,s){t.loading=!1,t.gameId=a.id,t.game=null,e.get("/game/"+t.gameId).then(function(e){t.game=new i(e.data),t.findUsers()}),t.findUsers=function(e){s.find(e,t)},t.onSelectUser=function(e){s.remove(e,t)},t.onRemoveUser=function(e){s.add(e,t)},t.update=function(){t.errors={},t.loading=!0,e({url:"/game/"+t.game.id,method:"PUT",data:t.game.getFormData()}).then(function(){t.loading=!1,n.path("/")})["catch"](function(e){t.loading=!1,t.errors=e})};var o=$("#playedAt");o.datetimepicker({format:"MM/DD/YYYY HH:mm",maxDate:new Date}),o.on("dp.change",function(){t.game.playedAt=$(this).val()})}]),app.controller("ComplainersCtrl",["$scope","$http","$routeParams","Game",function(t,e,n,r){t.loading=!1,t.gameId=n.id,t.game=null,e.get("/game/"+t.gameId).then(function(e){t.game=new r(e.data)})}]),app.controller("UsersEditCtrl",["$scope","$http","Upload","User",function(t,e,n,r){function a(e,n){for(var r in t.users)if(t.users[r].id===e)return t.users[r]=n,!0;return!1}function i(e){t.errors[e.id]={}}t.users=[],t.inEditing={},t.errors={},t.uploadPic=function(e,r){e.upload=n.upload({url:"/user/"+r.id+"/avatar",method:"POST",data:{avatar:e}}).then(function(e){for(var n in t.users)if(t.users[n].id===r.id)return t.users[n].avatar_url=e.data.avatar_url,!0})["catch"](function(){})},t.init=function(){e({url:"/users",method:"GET"}).success(function(e){angular.forEach(e.data,function(t){this.push(new r(t))},t.users)})},t.edit=function(n){i(n),e({url:"/user/"+n.id,method:"PUT",data:n.getFormData()}).error(function(e){t.errors[n.id]=e}).success(function(e){t.commitEditing(n),a(n.id,new r(e))})},t.beginEditing=function(e){i(e),e.editing=!0,t.inEditing[e.id]=angular.copy(e)},t.rollbackEditing=function(e){return i(e),e=angular.copy(t.inEditing[e.id]),e.editing=!1,delete t.inEditing[e.id],e},t.commitEditing=function(e){return delete t.inEditing[e.id],e.editing=!1,e},t.init()}]),app.controller("UserProfileCtrl",["$scope","$http","$timeout","Upload","Player",function(t,e,n,r,a){function i(){t.showAlert=!0,n(function(){t.showAlert=!1},2e3)}t.player=null,t.errors={},t.loading=!0,t.showAlert=!1,a.get().$promise.then(function(e){t.loading=!1,t.player=e}),t.saveChanges=function(e){t.errors={},t.loading=!0,a.update({id:t.player.id},e).$promise.then(function(e){t.loading=!1,i()})["catch"](function(e){t.loading=!1,t.errors=e.data})},t.$watch("avatar",function(){t.upload(t.avatar)}),t.upload=function(e){t.errors={},e&&!e.$error&&r.upload({url:"/user/"+t.player.id+"/avatar",data:{avatar:e}}).then(function(e){t.player.avatar_url=e.data.avatar+"?"+(new Date).getTime(),i()})["catch"](function(e){t.errors=e.data})}}]),app.factory("AuthUser",["$http",function(t){function e(t){return this.email=null,this.name=null,this.password=null,this.setData=function(t){angular.extend(this,t)},t&&this.setData(t),this}return e}]),app.controller("SignupCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,r,a){t.user=new a,t.errors=[],t.signup=function(n){e({url:"/signup",method:"POST",data:t.user}).success(function(){r.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var r=0;r<e[n].length;r++)t.errors.push(e[n][r])})}}]),app.controller("SigninCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,r,a){t.user=new a,t.errors=[],t.signin=function(n){e({url:"/signin",method:"POST",data:t.user}).success(function(t){r.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var r=0;r<e[n].length;r++)t.errors.push(e[n][r])})}}]);