var app=angular.module("kickerApp",["ngRoute","ui.select","ngSanitize"]).config(["$httpProvider","$interpolateProvider","$routeProvider",function(t,e,r){e.startSymbol("<%"),e.endSymbol("%>"),r.when("/signup",{templateUrl:"html/views/auth/signup.html",controller:"SignupCtrl"}).when("/signin",{templateUrl:"html/views/auth/signin.html",controller:"SigninCtrl"}).when("/",{templateUrl:"html/views/games/index.html"}).when("/game/create",{templateUrl:"html/views/games/create.html",controller:"CreateGameCtrl"}).when("/game/:id/update",{templateUrl:"html/views/games/update.html",controller:"UpdateGameCtrl"}).when("/chart",{templateUrl:"html/views/chart/index.html"}).when("/_=_",{templateUrl:"html/views/games/index.html"})}]);app.factory("User",["$http",function(t){function e(t){var e=this;return this.setData=function(t){angular.extend(this,t)},this.countGames=function(){return e.count_looses+e.count_wins+e.count_draws},this.avatarUrl=function(){return e.avatar_url?e.avatar_url:"/img/no-avatar.min.png"},t&&this.setData(t),this}return e}]),app.controller("ChartsCtrl",["$scope","$http","User",function(t,e,r){t.users=[],t.init=function(){t.loading=!0,e.get("/chart").success(function(e){angular.forEach(e,function(t,e){t.index=e+1;var n=new r(t);this.push(n)},t.users)})},t.init()}]),app.factory("GameUser",["$http","User",function(t,e){function r(t){var r=this;return this.setData=function(t){angular.extend(this,t),r.user=new e(r.user)},this.getDelta=function(){return r.rating_after-r.rating_before},this.userPointsClass=function(){return r.getDelta()>0?"win":"lose"},t&&this.setData(t),this}return r}]),app.factory("Game",["$http","GameUser",function(t,e){function r(t){var r=this;return this.setData=function(t){angular.extend(this,t);for(var n=0;n<r.games_users_a.length;n++)r.games_users_a[n]=new e(r.games_users_a[n]);for(n=0;n<r.games_users_b.length;n++)r.games_users_b[n]=new e(r.games_users_b[n])},this.gamePointClass=function(t){var e=r.team_a_points,n=r.team_b_points;return"b"===t&&(e=r.team_b_points,n=r.team_a_points),e>n?"win":n>e?"lose":"draw"},t&&this.setData(t),this}return r}]),app.factory("CreateGameService",["$http","$filter",function(t,e){function r(t){var r=this;return this.id=null,this.users={a:[],b:[]},this.points={a:0,b:0},this.playedAt=function(t){return e("date")(t,"MM/dd/yyyy HH:mm")}(new Date),this.teamIds=function(t){var e=this.users[t],r=[];return angular.forEach(e,function(t){this.push(t.id)},r),r},this.getSelectedIds=function(){return this.teamIds("a").concat(this.teamIds("b"))},this.exportUsers=function(t,e){var r=[];return angular.forEach(t["games_users_"+e],function(t){this.push(t.user)},r),r},this.setData=function(t){r.users={a:r.exportUsers(t,"a"),b:r.exportUsers(t,"b")},r.points={a:t.team_a_points,b:t.team_b_points},r.playedAt=t.played_at,r.id=t.id},this.getFormData=function(){return{games_users_a:r.teamIds("a"),team_a_points:r.points.a,games_users_b:r.teamIds("b"),team_b_points:r.points.b,played_at:r.playedAt}},t&&this.setData(t),this}return r}]),app.controller("GamesCtrl",["$scope","$http","Game",function(t,e,r){function n(e){angular.forEach(e,function(t){var e=new r(t);this.push(e),s[e.id]=this.length-1},t.games)}function a(){e({url:"/user/role",method:"GET"}).success(function(e){"guest"===e?t.user.isGuest=!0:"user"===e?t.user.isUser=!0:"admin"===e&&(t.user.isAdmin=!0)})}t.lastpage=1,t.currentpage=0,t.games=[],t.loading=!1,t.user={isGuest:!1,isUser:!1,isAdmin:!1};var s={};t.userRole=a(),t.init=function(){e({url:"/",method:"GET",params:{page:t.currentpage}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,n(e.data)})},t.loadMore=function(){t.loading=!0,e({url:"/",method:"GET",params:{page:t.currentpage+1}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,n(e.data),t.loading=!1})},t.complain=function(n){e.get("/game/"+n+"/complain").success(function(a){e.get("/game/"+n).success(function(e){var n=new r(e),a=s[n.id];t.games[a]=n})})},t.init()}]),app.controller("CreateGameCtrl",["$scope","$http","$location","$filter","CreateGameService",function(t,e,r,n,a){t.usersSearch=[],t.game=new a,t.errors={},t.findUsers=function(r){var n={search:r,"exceptIds[]":t.game.getSelectedIds()};return e.get("/user/search",{params:n}).then(function(e){t.usersSearch=e.data})},t.create=function(){t.errors={},e.post("/game/create",t.game.getFormData()).error(function(e){t.errors=e}).then(function(){r.path("/")})};var s=$("#playedAt");s.datetimepicker({format:"MM/DD/YYYY HH:mm"}),s.on("dp.change",function(){t.game.playedAt=$(this).val()})}]),app.controller("UpdateGameCtrl",["$scope","$http","$location","$filter","CreateGameService","$routeParams",function(t,e,r,n,a,s){t.gameId=s.id,t.game=null,e.get("/game/"+t.gameId).then(function(e){t.game=new a(e.data)}),t.findUsers=function(r){var n={search:r,"exceptIds[]":t.game.getSelectedIds()};return e.get("/user/search",{params:n}).then(function(e){t.usersSearch=e.data})},t.update=function(){t.errors={},e.post("/game/"+t.game.id+"/update",t.game.getFormData()).error(function(e){t.errors=e}).then(function(){r.path("/")})}}]),app.factory("AuthUser",["$http",function(t){function e(t){return this.email=null,this.name=null,this.password=null,this.setData=function(t){angular.extend(this,t)},t&&this.setData(t),this}return e}]),app.controller("SignupCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,r,n,a){t.user=new a,t.errors=[],t.signup=function(r){e({url:"/signup",method:"POST",data:t.user}).success(function(){n.location.href="/"}).error(function(e){t.errors=[];for(var r in e)if(e.hasOwnProperty(r))for(var n=0;n<e[r].length;n++)t.errors.push(e[r][n])})}}]),app.controller("SigninCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,r,n,a){t.user=new a,t.errors=[],t.signin=function(r){e({url:"/signin",method:"POST",data:t.user}).success(function(t){n.location.href="/"}).error(function(e){t.errors=[];for(var r in e)if(e.hasOwnProperty(r))for(var n=0;n<e[r].length;n++)t.errors.push(e[r][n])})}}]);