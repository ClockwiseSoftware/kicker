var app=angular.module("kickerApp",["ngRoute","ui.select","ngSanitize"]).config(["$httpProvider","$interpolateProvider","$routeProvider",function(t,e,n){e.startSymbol("<%"),e.endSymbol("%>"),n.when("/signup",{templateUrl:"html/views/auth/signup.html",controller:"SignupCtrl"}).when("/signin",{templateUrl:"html/views/auth/signin.html",controller:"SigninCtrl"}).when("/",{templateUrl:"html/views/games/index.html"}).when("/game/create",{templateUrl:"html/views/games/create.html",controller:"CreateGameCtrl"}).when("/chart",{templateUrl:"html/views/chart/index.html"}).when("/_=_",{templateUrl:"html/views/games/index.html"})}]);app.factory("User",["$http",function(t){function e(t){var e=this;return this.setData=function(t){angular.extend(this,t)},this.countGames=function(){return e.count_looses+e.count_wins+e.count_draws},this.avatarUrl=function(){return e.avatar_url?e.avatar_url:"/img/no-avatar.min.png"},t&&this.setData(t),this}return e}]),app.controller("ChartsCtrl",["$scope","$http","User",function(t,e,n){t.users=[],t.init=function(){t.loading=!0,e.get("/chart").success(function(e){angular.forEach(e,function(t,e){t.index=e+1;var r=new n(t);this.push(r)},t.users)})},t.init()}]),app.factory("GameUser",["$http","User",function(t,e){function n(t){var n=this;return this.setData=function(t){angular.extend(this,t),n.user=new e(n.user)},this.getDelta=function(){return n.rating_after-n.rating_before},this.userPointsClass=function(){return n.getDelta()>0?"win":"lose"},t&&this.setData(t),this}return n}]),app.factory("Game",["$http","GameUser",function(t,e){function n(t){var n=this;return this.setData=function(t){angular.extend(this,t);for(var r=0;r<n.games_users_a.length;r++)n.games_users_a[r]=new e(n.games_users_a[r]);for(r=0;r<n.games_users_b.length;r++)n.games_users_b[r]=new e(n.games_users_b[r])},this.gamePointClass=function(t){var e=n.team_a_points,r=n.team_b_points;return"b"===t&&(e=n.team_b_points,r=n.team_a_points),e>r?"win":r>e?"lose":"draw"},t&&this.setData(t),this}return n}]),app.factory("CreateGameService",["$http","$filter",function(t,e){function n(t){return this.users={a:[],b:[]},this.points={a:0,b:0},this.playedAt=function(t){return e("date")(t,"MM/dd/yyyy HH:mm")}(new Date),this.teamIds=function(t){var e=this.users[t],n=[];return angular.forEach(e,function(t){this.push(t.id)},n),n},this.getSelectedIds=function(){return this.teamIds("a").concat(this.teamIds("b"))},this.setData=function(t){angular.extend(this,t)},t&&this.setData(t),this}return n}]),app.controller("GamesCtrl",["$scope","$http","Game",function(t,e,n){function r(e){angular.forEach(e,function(t){var e=new n(t);this.push(e),s[e.id]=this.length-1},t.games)}function a(){e({url:"/user/role",method:"GET"}).success(function(e){"guest"===e?t.user.isGuest=!0:"user"===e?t.user.isUser=!0:"admin"===e&&(t.user.isAdmin=!0)})}t.lastpage=1,t.currentpage=0,t.games=[],t.loading=!1,t.user={isGuest:!1,isUser:!1,isAdmin:!1};var s={};t.userRole=a(),t.init=function(){e({url:"/",method:"GET",params:{page:t.currentpage}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,r(e.data)})},t.loadMore=function(){t.loading=!0,e({url:"/",method:"GET",params:{page:t.currentpage+1}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,r(e.data),t.loading=!1})},t.complain=function(r){e.get("/game/"+r+"/complain").success(function(a){e.get("/game/"+r).success(function(e){var r=new n(e),a=s[r.id];t.games[a]=r})})},t.init()}]),app.controller("CreateGameCtrl",["$scope","$http","$location","$filter","CreateGameService",function(t,e,n,r,a){t.usersSearch=[],t.game=new a,t.errors={},t.findUsers=function(n){var r={search:n,"exceptIds[]":t.game.getSelectedIds()};return e.get("/user/search",{params:r}).then(function(e){t.usersSearch=e.data})},t.create=function(){var r={games_users_a:t.game.teamIds("a"),team_a_points:t.game.points.a,games_users_b:t.game.teamIds("b"),team_b_points:t.game.points.b,played_at:t.game.playedAt};t.errors={},e.post("/game/create",r).error(function(e){t.errors=e}).then(function(){n.path("/")})};var s=$("#playedAt");s.datetimepicker({format:"MM/DD/YYYY HH:mm"}),s.on("dp.change",function(){t.game.playedAt=$(this).val()})}]),app.factory("AuthUser",["$http",function(t){function e(t){return this.email=null,this.name=null,this.password=null,this.setData=function(t){angular.extend(this,t)},t&&this.setData(t),this}return e}]),app.controller("SignupCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,r,a){t.user=new a,t.errors=[],t.signup=function(n){e({url:"/signup",method:"POST",data:t.user}).success(function(){r.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var r=0;r<e[n].length;r++)t.errors.push(e[n][r])})}}]),app.controller("SigninCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,r,a){t.user=new a,t.errors=[],t.signin=function(n){e({url:"/signin",method:"POST",data:t.user}).success(function(t){r.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var r=0;r<e[n].length;r++)t.errors.push(e[n][r])})}}]);