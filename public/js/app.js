var app=angular.module("kickerApp",["ngRoute","ui.select","ngSanitize","ui.bootstrap","ngFileUpload","ngResource"]).config(["$httpProvider","$routeProvider",function(e,t){t.when("/signup",{templateUrl:"html/views/auth/signup.html",controller:"SignupCtrl"}).when("/signin",{templateUrl:"html/views/auth/signin.html",controller:"SigninCtrl"}).when("/",{templateUrl:"html/views/games/index.html"}).when("/game/create",{templateUrl:"html/views/games/create.html",controller:"CreateGameCtrl"}).when("/game/:id/update",{templateUrl:"html/views/games/update.html",controller:"UpdateGameCtrl"}).when("/game/:id/complainers",{templateUrl:"html/views/games/complainers.html",controller:"ComplainersCtrl"}).when("/admin/users",{templateUrl:"html/views/admin/users.html",controller:"UsersEditCtrl"}).when("/user/profile",{templateUrl:"html/views/user/profile.html",controller:"UserProfileCtrl"}).when("/chart",{templateUrl:"html/views/chart/index.html"}).when("/_=_",{templateUrl:"html/views/games/index.html"}),$(window).on("popstate",function(){$(".navbar-collapse").collapse("hide")}),$("body").on("click",".navbar-collapse li",function(){$(this).closest(".navbar-collapse").collapse("hide")})}]);Date.parseISO=function(e){var t=new Date(e);if(isNaN(t.getDate())){for(var r=e.split(" "),n=r[0].split("-"),a=r[1].split(":"),i=0;i<n.length;i++)n[i]=parseInt(n[i]);for(i=0;i<a.length;i++)a[i]=parseInt(a[i]);t=new Date(n[0],n[1]-1,n[2],a[0],a[1],a[2])}return t},function(e){e.directive("backImg",function(){return function(e,t,r){r.$observe("backImg",function(e){t.css({"background-image":"url("+e+")","background-size":"cover"})})}})}(angular.module("kickerApp")),function(e){e.directive("numberOnly",function(){return{require:"ngModel",link:function(e,t,r,n){n.$parsers.push(function(e){var t=parseInt(e),a=parseInt(r.min),i=parseInt(r.max),s=a;return s=t>i?i:t>=a?t:a,n.$setViewValue(s),n.$render(),s})}}})}(angular.module("kickerApp")),app.factory("User",["$http",function(e){function t(e){var t=this;return this.editing=!1,this.setData=function(e){angular.extend(this,e)},this.countGames=function(){return t.count_looses+t.count_wins+t.count_draws},this.avatarUrl=function(){return t.avatar_url?t.avatar_url:"/img/no-avatar.min.png"},this.getFormData=function(){var e={name:t.name,email:t.email};return t.password&&(e.password=t.password),e},e&&this.setData(e),this}return t}]),app.controller("ChartsCtrl",["$scope","$http","User",function(e,t,r){e.orderByField="index",e.reverseSort=!1,e.users=[],e.me=null,e.init=function(){e.loading=!0,t.get("/chart").success(function(t){angular.forEach(t,function(e,t){e.index=t+1;var n=new r(e);n.countGamesPlayed=n.countGames(),this.push(n)},e.users)})},t.get("/user/me").success(function(t){return t?void(e.me=new r(t)):!1}),e.init()}]),app.factory("GameUser",["$http","User",function(e,t){function r(e){var r=this;return this.setData=function(e){angular.extend(this,e),r.user=new t(r.user)},this.getDelta=function(){return r.rating_after-r.rating_before},this.userPointsClass=function(){return r.getDelta()>0?"win":"lose"},e&&this.setData(e),this}return r}]),app.factory("Game",["$http","$filter","$sce","GameUser","User",function(e,t,r,n,a){function i(e){var i=this;return this.complaintsHtml="",this.tooltipIsVisible=!1,this.loading=!1,this.setData=function(e){angular.extend(this,e);for(var s=0;s<i.games_users_a.length;s++)i.games_users_a[s]=new n(i.games_users_a[s]);for(s=0;s<i.games_users_b.length;s++)i.games_users_b[s]=new n(i.games_users_b[s]);for(s=0;s<i.complaints.length;s++)i.complaints[s].user=new a(i.complaints[s].user);i.played_at=function(e){return t("date")(e,"MM/dd/yyyy HH:mm")}(Date.parseISO(i.played_at)),i.complaintsHtml=function(e){var t=5,n="",a=e.length>t?t:e.length;if(e.length<=0)return null;for(var s=0;a>s;s++){var o=i.complaints[s].user;o&&(n+='<span class="complain-user"><img src="'+o.avatarUrl()+'" /></span>')}return n+='<div><a href="#/game/'+i.id+'/complainers" class="see-all-complainers">See all</a></div>',r.trustAsHtml(n)}(i.complaints)},this.gamePointClass=function(e){var t=i.team_a_points,r=i.team_b_points;return"b"===e&&(t=i.team_b_points,r=i.team_a_points),t>r?"win":r>t?"lose":"draw"},e&&this.setData(e),this}return i.prototype.MAX_POINTS=10,i.prototype.MIN_POINTS=0,i}]),app.factory("CreateGameService",["$http","$filter",function(e,t){function r(e){function r(e){return t("date")(e,"MM/dd/yyyy HH:mm")}var n=this;return this.id=null,this.users={a:[],b:[]},this.points={a:0,b:0},this.playedAt=r(new Date),this.teamIds=function(e){var t=this.users[e],r=[];return angular.forEach(t,function(e){this.push(e.id)},r),r},this.getSelectedIds=function(){return this.teamIds("a").concat(this.teamIds("b"))},this.exportUsers=function(e,t){var r=[];return angular.forEach(e["games_users_"+t],function(e){this.push(e.user)},r),r},this.setData=function(e){n.users={a:n.exportUsers(e,"a"),b:n.exportUsers(e,"b")},n.points={a:e.team_a_points,b:e.team_b_points},n.playedAt=r(Date.parseISO(e.played_at)),n.id=e.id},this.getFormData=function(){return{games_users_a:n.teamIds("a"),team_a_points:n.points.a,games_users_b:n.teamIds("b"),team_b_points:n.points.b,played_at:n.playedAt}},e&&this.setData(e),this}return r.prototype.MAX_POINTS=10,r.prototype.MIN_POINTS=0,r}]),app.factory("UserSearch",["$http",function(e){function t(){}return t.find=function(t,r){if(r.searchRequestPending||null===r.game)return!1;r.searchRequestPending=!0;var n=r.game.getSelectedIds(),a={};return t=t?t.trim():t,n.length>0&&(a["exceptIds[]"]=n),t&&(a.search=t),e.get("/user/search",{params:a}).then(function(e){0===e.data.length?r.usersSearch=[{name:"No results..."}]:r.usersSearch=e.data,r.searchRequestPending=!1})},t.remove=function(e,t){for(var r=0;r<t.usersSearch.length;r++)if(e.id===t.usersSearch[r].id){t.usersSearch.splice(r,1);break}},t.add=function(e,t){t.usersSearch.unshift(e)},t}]),function(e){e.factory("Player",["$resource",function(e){return e("user/me",{id:"@id"},{get:{method:"GET",isArray:!1},update:{method:"PUT",url:"user/:id"}})}])}(angular.module("kickerApp")),app.factory("GamesRepository",["$http","Game",function(e,t){function r(){this.storage=[],this.loading=!0,this.lastpage=0,this.currentpage=0;var r=this,n={};return this.add=function(e){angular.forEach(e,function(e){var r=new t(e);this.push(r),n[r.id]=this.length-1},r.storage)},this.get=function(e){var t=n[e];return r.storage.hasOwnProperty(t)?r.storage[t]:null},this.update=function(e,n){var a=r.get(e);return angular.copy(new t(n),a),a},this.load=function(t){r.loading=!0,e({url:"/",method:"GET",params:{page:r.currentpage+1}}).success(function(e){e.data.length>0&&(r.currentpage=e.current_page,r.lastpage=e.last_page,r.add(e.data)),r.loading=!1}),t&&t.call()},this}return r}]),app.controller("GamesCtrl",["$scope","$http","Game","GamesRepository",function(e,t,r,n){function a(){t({url:"/user/role",method:"GET"}).success(function(t){"guest"===t?e.user.isGuest=!0:"user"===t?e.user.isUser=!0:"admin"===t&&(e.user.isAdmin=!0)})}e.gamesRepository=new n,e.games=e.gamesRepository.storage,e.gamesRepository.load(),e.user={isGuest:!1,isUser:!1,isAdmin:!1},e.userRole=a(),e.complain=function(r){var n=e.gamesRepository.get(r);n.loading=!0,t.get("/game/"+r+"/complain").success(function(a){t.get("/game/"+r).success(function(t){n.loading=!1,e.gamesRepository.update(t.id,t)})})}}]),app.controller("CreateGameCtrl",["$scope","$http","$location","$filter","CreateGameService","UserSearch",function(e,t,r,n,a,i){e.loading=!1,e.game=new a,e.errors={},e.findUsers=function(t){i.find(t,e)},e.onSelectUser=function(t){i.remove(t,e)},e.onRemoveUser=function(t){i.add(t,e)},e.create=function(){e.errors={},e.loading=!0,t.post("/game/create",e.game.getFormData()).error(function(t){e.errors=t}).then(function(){e.loading=!1,r.path("/")},function(){e.loading=!1})};var s=$("#playedAt");s.datetimepicker({format:"MM/DD/YYYY HH:mm",maxDate:new Date}),s.on("dp.change",function(){e.game.playedAt=$(this).val()})}]),app.controller("UpdateGameCtrl",["$scope","$http","$location","$filter","$routeParams","CreateGameService","UserSearch",function(e,t,r,n,a,i,s){e.loading=!1,e.gameId=a.id,e.game=null,t.get("/game/"+e.gameId).then(function(t){e.game=new i(t.data),e.findUsers()}),e.findUsers=function(t){s.find(t,e)},e.onSelectUser=function(t){s.remove(t,e)},e.onRemoveUser=function(t){s.add(t,e)},e.update=function(){e.errors={},e.loading=!0,t.post("/game/"+e.game.id+"/update",e.game.getFormData()).error(function(t){e.loading=!1,e.errors=t}).then(function(){e.loading=!1,r.path("/")})};var o=$("#playedAt");o.datetimepicker({format:"MM/DD/YYYY HH:mm",maxDate:new Date}),o.on("dp.change",function(){e.game.playedAt=$(this).val()})}]),app.controller("ComplainersCtrl",["$scope","$http","$routeParams","Game",function(e,t,r,n){e.loading=!1,e.gameId=r.id,e.game=null,t.get("/game/"+e.gameId).then(function(t){e.game=new n(t.data)})}]),app.controller("UsersEditCtrl",["$scope","$http","Upload","User",function(e,t,r,n){function a(t,r){for(var n in e.users)if(e.users[n].id===t)return e.users[n]=r,!0;return!1}function i(t){e.errors[t.id]={}}e.users=[],e.inEditing={},e.errors={},e.uploadPic=function(t,n){t.upload=r.upload({url:"/user/"+n.id+"/avatar",method:"POST",data:{avatar:t}}).then(function(t){for(var r in e.users)if(e.users[r].id===n.id)return e.users[r].avatar_url=t.data.avatar_url,!0})["catch"](function(){})},e.init=function(){t({url:"/users",method:"GET"}).success(function(t){angular.forEach(t.data,function(e){this.push(new n(e))},e.users)})},e.edit=function(r){i(r),t({url:"/user/"+r.id,method:"PUT",data:r.getFormData()}).error(function(t){e.errors[r.id]=t}).success(function(t){e.commitEditing(r),a(r.id,new n(t))})},e.beginEditing=function(t){i(t),t.editing=!0,e.inEditing[t.id]=angular.copy(t)},e.rollbackEditing=function(t){return i(t),t=angular.copy(e.inEditing[t.id]),t.editing=!1,delete e.inEditing[t.id],t},e.commitEditing=function(t){return delete e.inEditing[t.id],t.editing=!1,t},e.init()}]),app.controller("UserProfileCtrl",["$scope","$http","Upload","Player",function(e,t,r,n){e.player=null,e.errors={},e.loading=!0,n.get().$promise.then(function(t){e.loading=!1,e.player=t}),e.saveChanges=function(t){e.errors={},e.loading=!0,n.update({id:e.player.id},t).$promise.then(function(t){e.loading=!1})["catch"](function(t){e.loading=!1,e.errors=t.data})},e.$watch("avatar",function(){e.upload(e.avatar)}),e.upload=function(t){e.errors={},t&&!t.$error&&r.upload({url:"/user/"+e.player.id+"/avatar",data:{avatar:t}}).then(function(t){e.player.avatar_url=t.data.avatar+"?"+(new Date).getTime()})["catch"](function(t){e.errors=t.data})}}]),app.factory("AuthUser",["$http",function(e){function t(e){return this.email=null,this.name=null,this.password=null,this.setData=function(e){angular.extend(this,e)},e&&this.setData(e),this}return t}]),app.controller("SignupCtrl",["$scope","$http","$location","$window","AuthUser",function(e,t,r,n,a){e.user=new a,e.errors=[],e.signup=function(r){t({url:"/signup",method:"POST",data:e.user}).success(function(){n.location.href="/"}).error(function(t){e.errors=[];for(var r in t)if(t.hasOwnProperty(r))for(var n=0;n<t[r].length;n++)e.errors.push(t[r][n])})}}]),app.controller("SigninCtrl",["$scope","$http","$location","$window","AuthUser",function(e,t,r,n,a){e.user=new a,e.errors=[],e.signin=function(r){t({url:"/signin",method:"POST",data:e.user}).success(function(e){n.location.href="/"}).error(function(t){e.errors=[];for(var r in t)if(t.hasOwnProperty(r))for(var n=0;n<t[r].length;n++)e.errors.push(t[r][n])})}}]);