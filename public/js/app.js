var app=angular.module("kickerApp",["ngRoute","ui.select","ngSanitize"]).config(["$httpProvider","$interpolateProvider","$routeProvider",function(t,e,n){e.startSymbol("<%"),e.endSymbol("%>"),n.when("/signup",{templateUrl:"html/views/auth/signup.html",controller:"SignupCtrl"}).when("/signin",{templateUrl:"html/views/auth/signin.html",controller:"SigninCtrl"}).when("/",{templateUrl:"html/views/games/index.html"}).when("/game/create",{templateUrl:"html/views/games/create.html",controller:"CreateGameCtrl"}).when("/game/:id/update",{templateUrl:"html/views/games/update.html",controller:"UpdateGameCtrl"}).when("/chart",{templateUrl:"html/views/chart/index.html"}).when("/_=_",{templateUrl:"html/views/games/index.html"})}]);app.factory("User",["$http",function(t){function e(t){var e=this;return this.setData=function(t){angular.extend(this,t)},this.countGames=function(){return e.count_looses+e.count_wins+e.count_draws},this.avatarUrl=function(){return e.avatar_url?e.avatar_url:"/img/no-avatar.min.png"},t&&this.setData(t),this}return e}]),app.controller("ChartsCtrl",["$scope","$http","User",function(t,e,n){t.users=[],t.init=function(){t.loading=!0,e.get("/chart").success(function(e){angular.forEach(e,function(t,e){t.index=e+1;var a=new n(t);this.push(a)},t.users)})},t.init()}]),app.factory("GameUser",["$http","User",function(t,e){function n(t){var n=this;return this.setData=function(t){angular.extend(this,t),n.user=new e(n.user)},this.getDelta=function(){return n.rating_after-n.rating_before},this.userPointsClass=function(){return n.getDelta()>0?"win":"lose"},t&&this.setData(t),this}return n}]),app.factory("Game",["$http","GameUser",function(t,e){function n(t){var n=this;return this.setData=function(t){angular.extend(this,t);for(var a=0;a<n.games_users_a.length;a++)n.games_users_a[a]=new e(n.games_users_a[a]);for(a=0;a<n.games_users_b.length;a++)n.games_users_b[a]=new e(n.games_users_b[a])},this.gamePointClass=function(t){var e=n.team_a_points,a=n.team_b_points;return"b"===t&&(e=n.team_b_points,a=n.team_a_points),e>a?"win":a>e?"lose":"draw"},t&&this.setData(t),this}return n}]),app.factory("CreateGameService",["$http","$filter",function(t,e){function n(t){var n=this;return this.id=null,this.users={a:[],b:[]},this.points={a:0,b:0},this.playedAt=function(t){return e("date")(t,"MM/dd/yyyy HH:mm")}(new Date),this.teamIds=function(t){var e=this.users[t],n=[];return angular.forEach(e,function(t){this.push(t.id)},n),n},this.getSelectedIds=function(){return this.teamIds("a").concat(this.teamIds("b"))},this.exportUsers=function(t,e){var n=[];return angular.forEach(t["games_users_"+e],function(t){this.push(t.user)},n),n},this.setData=function(t){n.users={a:n.exportUsers(t,"a"),b:n.exportUsers(t,"b")},n.points={a:t.team_a_points,b:t.team_b_points},n.playedAt=t.played_at,n.id=t.id},this.getFormData=function(){return{games_users_a:n.teamIds("a"),team_a_points:n.points.a,games_users_b:n.teamIds("b"),team_b_points:n.points.b,played_at:n.playedAt}},t&&this.setData(t),this}return n}]),app.controller("GamesCtrl",["$scope","$http","Game",function(t,e,n){function a(e){angular.forEach(e,function(t){var e=new n(t);this.push(e),s[e.id]=this.length-1},t.games)}function r(){e({url:"/user/role",method:"GET"}).success(function(e){"guest"===e?t.user.isGuest=!0:"user"===e?t.user.isUser=!0:"admin"===e&&(t.user.isAdmin=!0)})}t.lastpage=1,t.currentpage=0,t.games=[],t.loading=!1,t.user={isGuest:!1,isUser:!1,isAdmin:!1};var s={};t.userRole=r(),t.init=function(){e({url:"/",method:"GET",params:{page:t.currentpage}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,a(e.data)})},t.loadMore=function(){t.loading=!0,e({url:"/",method:"GET",params:{page:t.currentpage+1}}).success(function(e){t.currentpage=e.current_page,t.lastpage=e.last_page,a(e.data),t.loading=!1})},t.complain=function(a){e.get("/game/"+a+"/complain").success(function(r){e.get("/game/"+a).success(function(e){var a=new n(e),r=s[a.id];t.games[r]=a})})},t.init()}]),app.controller("CreateGameCtrl",["$scope","$http","$location","$filter","CreateGameService",function(t,e,n,a,r){t.loading=!1,t.usersSearch=[],t.game=new r,t.errors={},t.findUsers=function(n){var a={search:n,"exceptIds[]":t.game.getSelectedIds()};return e.get("/user/search",{params:a}).then(function(e){t.usersSearch=e.data})},t.create=function(){t.errors={},t.loading=!0,e.post("/game/create",t.game.getFormData()).error(function(e){t.errors=e}).then(function(){t.loading=!1,n.path("/")},function(){t.loading=!1})};var s=$("#playedAt");s.datetimepicker({format:"MM/DD/YYYY HH:mm"}),s.on("dp.change",function(){t.game.playedAt=$(this).val()})}]),app.controller("UpdateGameCtrl",["$scope","$http","$location","$filter","CreateGameService","$routeParams",function(t,e,n,a,r,s){t.loading=!1,t.gameId=s.id,t.game=null,e.get("/game/"+t.gameId).then(function(e){t.game=new r(e.data)}),t.findUsers=function(n){var a={search:n,"exceptIds[]":t.game?t.game.getSelectedIds():[]};return e.get("/user/search",{params:a}).then(function(e){t.usersSearch=e.data})},t.update=function(){t.errors={},t.loading=!0,e.post("/game/"+t.game.id+"/update",t.game.getFormData()).error(function(e){t.loading=!1,t.errors=e}).then(function(){t.loading=!1,n.path("/")})}}]),app.factory("AuthUser",["$http",function(t){function e(t){return this.email=null,this.name=null,this.password=null,this.setData=function(t){angular.extend(this,t)},t&&this.setData(t),this}return e}]),app.controller("SignupCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,a,r){t.user=new r,t.errors=[],t.signup=function(n){e({url:"/signup",method:"POST",data:t.user}).success(function(){a.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var a=0;a<e[n].length;a++)t.errors.push(e[n][a])})}}]),app.controller("SigninCtrl",["$scope","$http","$location","$window","AuthUser",function(t,e,n,a,r){t.user=new r,t.errors=[],t.signin=function(n){e({url:"/signin",method:"POST",data:t.user}).success(function(t){a.location.href="/"}).error(function(e){t.errors=[];for(var n in e)if(e.hasOwnProperty(n))for(var a=0;a<e[n].length;a++)t.errors.push(e[n][a])})}}]);